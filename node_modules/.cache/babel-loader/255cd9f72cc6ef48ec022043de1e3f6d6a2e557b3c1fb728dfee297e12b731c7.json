{"ast":null,"code":"/**\n * WebSocket для получения сообщений в реальном времени\n * Улучшенная версия с более надёжной обработкой соединения\n */import{getWsUrl}from'./api';let ws=null;let listeners=[];let reconnectTimer=null;let heartbeatTimer=null;let isConnected=false;let isConnecting=false;let pendingMessages=[];let reconnectAttempts=0;const MAX_RECONNECT_ATTEMPTS=10;const RECONNECT_DELAY=3000;// 3 секунды\n/**\n * Подключиться к WebSocket\n */export function connectChatWebSocket(token,onMessage){if(ws&&isConnected){// Если уже подключены, добавляем слушателя\nif(onMessage&&!listeners.includes(onMessage)){listeners.push(onMessage);}return;}if(isConnecting){// Уже пытаемся подключиться\nif(onMessage&&!listeners.includes(onMessage)){listeners.push(onMessage);}return;}isConnecting=true;const url=\"\".concat(getWsUrl(),\"?token=\").concat(encodeURIComponent(token));try{ws=new WebSocket(url);ws.onopen=()=>{console.log('[ChatWS] Connected');isConnected=true;isConnecting=false;reconnectAttempts=0;// Запускаем heartbeat для поддержания соединения\nstartHeartbeat();// Отправляем отложенные сообщения\nwhile(pendingMessages.length>0){const msg=pendingMessages.shift();ws.send(JSON.stringify(msg));}// Оповещаем слушателей о подключении\nlisteners.forEach(listener=>{try{listener({type:'connected'});}catch(e){console.error('[ChatWS] Error in listener:',e);}});};ws.onmessage=event=>{try{const data=JSON.parse(event.data);console.log('[ChatWS] Received:',data);// Обработка heartbeat\nif(data.type==='pong'){return;}// Оповещаем всех слушателей\nlisteners.forEach(listener=>{try{listener(data);}catch(e){console.error('[ChatWS] Error in listener:',e);}});}catch(e){console.error('[ChatWS] Error parsing message:',e);}};ws.onclose=event=>{console.log('[ChatWS] Disconnected, code:',event.code,'reason:',event.reason);isConnected=false;isConnecting=false;ws=null;stopHeartbeat();// Оповещаем слушателей о отключении\nlisteners.forEach(listener=>{try{listener({type:'disconnected'});}catch(e){console.error('[ChatWS] Error in listener:',e);}});// Автоматическое переподключение\nif(reconnectAttempts<MAX_RECONNECT_ATTEMPTS){reconnectAttempts++;const delay=RECONNECT_DELAY*Math.min(reconnectAttempts,5);// Экспоненциальная задержка\nconsole.log(\"[ChatWS] Reconnecting in \".concat(delay,\"ms (attempt \").concat(reconnectAttempts,\"/\").concat(MAX_RECONNECT_ATTEMPTS,\")\"));reconnectTimer=setTimeout(()=>{const newToken=localStorage.getItem('aist_token');if(newToken){connectChatWebSocket(newToken);}},delay);}else{console.error('[ChatWS] Max reconnect attempts reached');}};ws.onerror=error=>{console.error('[ChatWS] Error:',error);};if(onMessage)listeners.push(onMessage);}catch(e){console.error('[ChatWS] Connection error:',e);isConnecting=false;}}/**\n * Запустить heartbeat (периодические ping-сообщения)\n */function startHeartbeat(){stopHeartbeat();heartbeatTimer=setInterval(()=>{if(ws&&isConnected){try{ws.send(JSON.stringify({type:'ping'}));}catch(e){console.error('[ChatWS] Heartbeat error:',e);}}},30000);// Каждые 30 секунд\n}/**\n * Остановить heartbeat\n */function stopHeartbeat(){if(heartbeatTimer){clearInterval(heartbeatTimer);heartbeatTimer=null;}}/**\n * Отправить сообщение через WebSocket\n */export function send(data){if(ws&&isConnected){try{ws.send(JSON.stringify(data));return true;}catch(e){console.error('[ChatWS] Send error:',e);pendingMessages.push(data);return false;}}else{pendingMessages.push(data);return false;}}/**\n * Добавить слушателя сообщений\n */export function addListener(listener){if(!listeners.includes(listener)){listeners.push(listener);}}/**\n * Удалить слушателя сообщений\n */export function removeListener(listener){listeners=listeners.filter(l=>l!==listener);}/**\n * Отключиться от WebSocket\n */export function disconnect(){stopHeartbeat();if(reconnectTimer){clearTimeout(reconnectTimer);reconnectTimer=null;}if(ws){try{ws.close();}catch(e){console.error('[ChatWS] Close error:',e);}ws=null;}listeners=[];isConnected=false;isConnecting=false;pendingMessages=[];reconnectAttempts=0;}/**\n * Проверить, подключен ли WebSocket\n */export function isWebSocketConnected(){return isConnected;}/**\n * Проверить, идёт ли подключение\n */export function isWebSocketConnecting(){return isConnecting;}/**\n * Получить количество попыток переподключения\n */export function getReconnectAttempts(){return reconnectAttempts;}","map":{"version":3,"names":["getWsUrl","ws","listeners","reconnectTimer","heartbeatTimer","isConnected","isConnecting","pendingMessages","reconnectAttempts","MAX_RECONNECT_ATTEMPTS","RECONNECT_DELAY","connectChatWebSocket","token","onMessage","includes","push","url","concat","encodeURIComponent","WebSocket","onopen","console","log","startHeartbeat","length","msg","shift","send","JSON","stringify","forEach","listener","type","e","error","onmessage","event","data","parse","onclose","code","reason","stopHeartbeat","delay","Math","min","setTimeout","newToken","localStorage","getItem","onerror","setInterval","clearInterval","addListener","removeListener","filter","l","disconnect","clearTimeout","close","isWebSocketConnected","isWebSocketConnecting","getReconnectAttempts"],"sources":["C:/Users/Vladislav/Documents/GitHub/aist-messenger/src/lib/chatWebSocket.js"],"sourcesContent":["/**\n * WebSocket для получения сообщений в реальном времени\n * Улучшенная версия с более надёжной обработкой соединения\n */\nimport { getWsUrl } from './api';\n\nlet ws = null;\nlet listeners = [];\nlet reconnectTimer = null;\nlet heartbeatTimer = null;\nlet isConnected = false;\nlet isConnecting = false;\nlet pendingMessages = [];\nlet reconnectAttempts = 0;\nconst MAX_RECONNECT_ATTEMPTS = 10;\nconst RECONNECT_DELAY = 3000; // 3 секунды\n\n/**\n * Подключиться к WebSocket\n */\nexport function connectChatWebSocket(token, onMessage) {\n  if (ws && isConnected) {\n    // Если уже подключены, добавляем слушателя\n    if (onMessage && !listeners.includes(onMessage)) {\n      listeners.push(onMessage);\n    }\n    return;\n  }\n\n  if (isConnecting) {\n    // Уже пытаемся подключиться\n    if (onMessage && !listeners.includes(onMessage)) {\n      listeners.push(onMessage);\n    }\n    return;\n  }\n\n  isConnecting = true;\n  const url = `${getWsUrl()}?token=${encodeURIComponent(token)}`;\n\n  try {\n    ws = new WebSocket(url);\n\n    ws.onopen = () => {\n      console.log('[ChatWS] Connected');\n      isConnected = true;\n      isConnecting = false;\n      reconnectAttempts = 0;\n\n      // Запускаем heartbeat для поддержания соединения\n      startHeartbeat();\n\n      // Отправляем отложенные сообщения\n      while (pendingMessages.length > 0) {\n        const msg = pendingMessages.shift();\n        ws.send(JSON.stringify(msg));\n      }\n\n      // Оповещаем слушателей о подключении\n      listeners.forEach(listener => {\n        try {\n          listener({ type: 'connected' });\n        } catch (e) {\n          console.error('[ChatWS] Error in listener:', e);\n        }\n      });\n    };\n\n    ws.onmessage = (event) => {\n      try {\n        const data = JSON.parse(event.data);\n        console.log('[ChatWS] Received:', data);\n\n        // Обработка heartbeat\n        if (data.type === 'pong') {\n          return;\n        }\n\n        // Оповещаем всех слушателей\n        listeners.forEach(listener => {\n          try {\n            listener(data);\n          } catch (e) {\n            console.error('[ChatWS] Error in listener:', e);\n          }\n        });\n      } catch (e) {\n        console.error('[ChatWS] Error parsing message:', e);\n      }\n    };\n\n    ws.onclose = (event) => {\n      console.log('[ChatWS] Disconnected, code:', event.code, 'reason:', event.reason);\n      isConnected = false;\n      isConnecting = false;\n      ws = null;\n      stopHeartbeat();\n\n      // Оповещаем слушателей о отключении\n      listeners.forEach(listener => {\n        try {\n          listener({ type: 'disconnected' });\n        } catch (e) {\n          console.error('[ChatWS] Error in listener:', e);\n        }\n      });\n\n      // Автоматическое переподключение\n      if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {\n        reconnectAttempts++;\n        const delay = RECONNECT_DELAY * Math.min(reconnectAttempts, 5); // Экспоненциальная задержка\n        console.log(`[ChatWS] Reconnecting in ${delay}ms (attempt ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS})`);\n        reconnectTimer = setTimeout(() => {\n          const newToken = localStorage.getItem('aist_token');\n          if (newToken) {\n            connectChatWebSocket(newToken);\n          }\n        }, delay);\n      } else {\n        console.error('[ChatWS] Max reconnect attempts reached');\n      }\n    };\n\n    ws.onerror = (error) => {\n      console.error('[ChatWS] Error:', error);\n    };\n\n    if (onMessage) listeners.push(onMessage);\n  } catch (e) {\n    console.error('[ChatWS] Connection error:', e);\n    isConnecting = false;\n  }\n}\n\n/**\n * Запустить heartbeat (периодические ping-сообщения)\n */\nfunction startHeartbeat() {\n  stopHeartbeat();\n  heartbeatTimer = setInterval(() => {\n    if (ws && isConnected) {\n      try {\n        ws.send(JSON.stringify({ type: 'ping' }));\n      } catch (e) {\n        console.error('[ChatWS] Heartbeat error:', e);\n      }\n    }\n  }, 30000); // Каждые 30 секунд\n}\n\n/**\n * Остановить heartbeat\n */\nfunction stopHeartbeat() {\n  if (heartbeatTimer) {\n    clearInterval(heartbeatTimer);\n    heartbeatTimer = null;\n  }\n}\n\n/**\n * Отправить сообщение через WebSocket\n */\nexport function send(data) {\n  if (ws && isConnected) {\n    try {\n      ws.send(JSON.stringify(data));\n      return true;\n    } catch (e) {\n      console.error('[ChatWS] Send error:', e);\n      pendingMessages.push(data);\n      return false;\n    }\n  } else {\n    pendingMessages.push(data);\n    return false;\n  }\n}\n\n/**\n * Добавить слушателя сообщений\n */\nexport function addListener(listener) {\n  if (!listeners.includes(listener)) {\n    listeners.push(listener);\n  }\n}\n\n/**\n * Удалить слушателя сообщений\n */\nexport function removeListener(listener) {\n  listeners = listeners.filter(l => l !== listener);\n}\n\n/**\n * Отключиться от WebSocket\n */\nexport function disconnect() {\n  stopHeartbeat();\n  if (reconnectTimer) {\n    clearTimeout(reconnectTimer);\n    reconnectTimer = null;\n  }\n  if (ws) {\n    try {\n      ws.close();\n    } catch (e) {\n      console.error('[ChatWS] Close error:', e);\n    }\n    ws = null;\n  }\n  listeners = [];\n  isConnected = false;\n  isConnecting = false;\n  pendingMessages = [];\n  reconnectAttempts = 0;\n}\n\n/**\n * Проверить, подключен ли WebSocket\n */\nexport function isWebSocketConnected() {\n  return isConnected;\n}\n\n/**\n * Проверить, идёт ли подключение\n */\nexport function isWebSocketConnecting() {\n  return isConnecting;\n}\n\n/**\n * Получить количество попыток переподключения\n */\nexport function getReconnectAttempts() {\n  return reconnectAttempts;\n}\n"],"mappings":"AAAA;AACA;AACA;AACA,GACA,OAASA,QAAQ,KAAQ,OAAO,CAEhC,GAAI,CAAAC,EAAE,CAAG,IAAI,CACb,GAAI,CAAAC,SAAS,CAAG,EAAE,CAClB,GAAI,CAAAC,cAAc,CAAG,IAAI,CACzB,GAAI,CAAAC,cAAc,CAAG,IAAI,CACzB,GAAI,CAAAC,WAAW,CAAG,KAAK,CACvB,GAAI,CAAAC,YAAY,CAAG,KAAK,CACxB,GAAI,CAAAC,eAAe,CAAG,EAAE,CACxB,GAAI,CAAAC,iBAAiB,CAAG,CAAC,CACzB,KAAM,CAAAC,sBAAsB,CAAG,EAAE,CACjC,KAAM,CAAAC,eAAe,CAAG,IAAI,CAAE;AAE9B;AACA;AACA,GACA,MAAO,SAAS,CAAAC,oBAAoBA,CAACC,KAAK,CAAEC,SAAS,CAAE,CACrD,GAAIZ,EAAE,EAAII,WAAW,CAAE,CACrB;AACA,GAAIQ,SAAS,EAAI,CAACX,SAAS,CAACY,QAAQ,CAACD,SAAS,CAAC,CAAE,CAC/CX,SAAS,CAACa,IAAI,CAACF,SAAS,CAAC,CAC3B,CACA,OACF,CAEA,GAAIP,YAAY,CAAE,CAChB;AACA,GAAIO,SAAS,EAAI,CAACX,SAAS,CAACY,QAAQ,CAACD,SAAS,CAAC,CAAE,CAC/CX,SAAS,CAACa,IAAI,CAACF,SAAS,CAAC,CAC3B,CACA,OACF,CAEAP,YAAY,CAAG,IAAI,CACnB,KAAM,CAAAU,GAAG,IAAAC,MAAA,CAAMjB,QAAQ,CAAC,CAAC,YAAAiB,MAAA,CAAUC,kBAAkB,CAACN,KAAK,CAAC,CAAE,CAE9D,GAAI,CACFX,EAAE,CAAG,GAAI,CAAAkB,SAAS,CAACH,GAAG,CAAC,CAEvBf,EAAE,CAACmB,MAAM,CAAG,IAAM,CAChBC,OAAO,CAACC,GAAG,CAAC,oBAAoB,CAAC,CACjCjB,WAAW,CAAG,IAAI,CAClBC,YAAY,CAAG,KAAK,CACpBE,iBAAiB,CAAG,CAAC,CAErB;AACAe,cAAc,CAAC,CAAC,CAEhB;AACA,MAAOhB,eAAe,CAACiB,MAAM,CAAG,CAAC,CAAE,CACjC,KAAM,CAAAC,GAAG,CAAGlB,eAAe,CAACmB,KAAK,CAAC,CAAC,CACnCzB,EAAE,CAAC0B,IAAI,CAACC,IAAI,CAACC,SAAS,CAACJ,GAAG,CAAC,CAAC,CAC9B,CAEA;AACAvB,SAAS,CAAC4B,OAAO,CAACC,QAAQ,EAAI,CAC5B,GAAI,CACFA,QAAQ,CAAC,CAAEC,IAAI,CAAE,WAAY,CAAC,CAAC,CACjC,CAAE,MAAOC,CAAC,CAAE,CACVZ,OAAO,CAACa,KAAK,CAAC,6BAA6B,CAAED,CAAC,CAAC,CACjD,CACF,CAAC,CAAC,CACJ,CAAC,CAEDhC,EAAE,CAACkC,SAAS,CAAIC,KAAK,EAAK,CACxB,GAAI,CACF,KAAM,CAAAC,IAAI,CAAGT,IAAI,CAACU,KAAK,CAACF,KAAK,CAACC,IAAI,CAAC,CACnChB,OAAO,CAACC,GAAG,CAAC,oBAAoB,CAAEe,IAAI,CAAC,CAEvC;AACA,GAAIA,IAAI,CAACL,IAAI,GAAK,MAAM,CAAE,CACxB,OACF,CAEA;AACA9B,SAAS,CAAC4B,OAAO,CAACC,QAAQ,EAAI,CAC5B,GAAI,CACFA,QAAQ,CAACM,IAAI,CAAC,CAChB,CAAE,MAAOJ,CAAC,CAAE,CACVZ,OAAO,CAACa,KAAK,CAAC,6BAA6B,CAAED,CAAC,CAAC,CACjD,CACF,CAAC,CAAC,CACJ,CAAE,MAAOA,CAAC,CAAE,CACVZ,OAAO,CAACa,KAAK,CAAC,iCAAiC,CAAED,CAAC,CAAC,CACrD,CACF,CAAC,CAEDhC,EAAE,CAACsC,OAAO,CAAIH,KAAK,EAAK,CACtBf,OAAO,CAACC,GAAG,CAAC,8BAA8B,CAAEc,KAAK,CAACI,IAAI,CAAE,SAAS,CAAEJ,KAAK,CAACK,MAAM,CAAC,CAChFpC,WAAW,CAAG,KAAK,CACnBC,YAAY,CAAG,KAAK,CACpBL,EAAE,CAAG,IAAI,CACTyC,aAAa,CAAC,CAAC,CAEf;AACAxC,SAAS,CAAC4B,OAAO,CAACC,QAAQ,EAAI,CAC5B,GAAI,CACFA,QAAQ,CAAC,CAAEC,IAAI,CAAE,cAAe,CAAC,CAAC,CACpC,CAAE,MAAOC,CAAC,CAAE,CACVZ,OAAO,CAACa,KAAK,CAAC,6BAA6B,CAAED,CAAC,CAAC,CACjD,CACF,CAAC,CAAC,CAEF;AACA,GAAIzB,iBAAiB,CAAGC,sBAAsB,CAAE,CAC9CD,iBAAiB,EAAE,CACnB,KAAM,CAAAmC,KAAK,CAAGjC,eAAe,CAAGkC,IAAI,CAACC,GAAG,CAACrC,iBAAiB,CAAE,CAAC,CAAC,CAAE;AAChEa,OAAO,CAACC,GAAG,6BAAAL,MAAA,CAA6B0B,KAAK,iBAAA1B,MAAA,CAAeT,iBAAiB,MAAAS,MAAA,CAAIR,sBAAsB,KAAG,CAAC,CAC3GN,cAAc,CAAG2C,UAAU,CAAC,IAAM,CAChC,KAAM,CAAAC,QAAQ,CAAGC,YAAY,CAACC,OAAO,CAAC,YAAY,CAAC,CACnD,GAAIF,QAAQ,CAAE,CACZpC,oBAAoB,CAACoC,QAAQ,CAAC,CAChC,CACF,CAAC,CAAEJ,KAAK,CAAC,CACX,CAAC,IAAM,CACLtB,OAAO,CAACa,KAAK,CAAC,yCAAyC,CAAC,CAC1D,CACF,CAAC,CAEDjC,EAAE,CAACiD,OAAO,CAAIhB,KAAK,EAAK,CACtBb,OAAO,CAACa,KAAK,CAAC,iBAAiB,CAAEA,KAAK,CAAC,CACzC,CAAC,CAED,GAAIrB,SAAS,CAAEX,SAAS,CAACa,IAAI,CAACF,SAAS,CAAC,CAC1C,CAAE,MAAOoB,CAAC,CAAE,CACVZ,OAAO,CAACa,KAAK,CAAC,4BAA4B,CAAED,CAAC,CAAC,CAC9C3B,YAAY,CAAG,KAAK,CACtB,CACF,CAEA;AACA;AACA,GACA,QAAS,CAAAiB,cAAcA,CAAA,CAAG,CACxBmB,aAAa,CAAC,CAAC,CACftC,cAAc,CAAG+C,WAAW,CAAC,IAAM,CACjC,GAAIlD,EAAE,EAAII,WAAW,CAAE,CACrB,GAAI,CACFJ,EAAE,CAAC0B,IAAI,CAACC,IAAI,CAACC,SAAS,CAAC,CAAEG,IAAI,CAAE,MAAO,CAAC,CAAC,CAAC,CAC3C,CAAE,MAAOC,CAAC,CAAE,CACVZ,OAAO,CAACa,KAAK,CAAC,2BAA2B,CAAED,CAAC,CAAC,CAC/C,CACF,CACF,CAAC,CAAE,KAAK,CAAC,CAAE;AACb,CAEA;AACA;AACA,GACA,QAAS,CAAAS,aAAaA,CAAA,CAAG,CACvB,GAAItC,cAAc,CAAE,CAClBgD,aAAa,CAAChD,cAAc,CAAC,CAC7BA,cAAc,CAAG,IAAI,CACvB,CACF,CAEA;AACA;AACA,GACA,MAAO,SAAS,CAAAuB,IAAIA,CAACU,IAAI,CAAE,CACzB,GAAIpC,EAAE,EAAII,WAAW,CAAE,CACrB,GAAI,CACFJ,EAAE,CAAC0B,IAAI,CAACC,IAAI,CAACC,SAAS,CAACQ,IAAI,CAAC,CAAC,CAC7B,MAAO,KAAI,CACb,CAAE,MAAOJ,CAAC,CAAE,CACVZ,OAAO,CAACa,KAAK,CAAC,sBAAsB,CAAED,CAAC,CAAC,CACxC1B,eAAe,CAACQ,IAAI,CAACsB,IAAI,CAAC,CAC1B,MAAO,MAAK,CACd,CACF,CAAC,IAAM,CACL9B,eAAe,CAACQ,IAAI,CAACsB,IAAI,CAAC,CAC1B,MAAO,MAAK,CACd,CACF,CAEA;AACA;AACA,GACA,MAAO,SAAS,CAAAgB,WAAWA,CAACtB,QAAQ,CAAE,CACpC,GAAI,CAAC7B,SAAS,CAACY,QAAQ,CAACiB,QAAQ,CAAC,CAAE,CACjC7B,SAAS,CAACa,IAAI,CAACgB,QAAQ,CAAC,CAC1B,CACF,CAEA;AACA;AACA,GACA,MAAO,SAAS,CAAAuB,cAAcA,CAACvB,QAAQ,CAAE,CACvC7B,SAAS,CAAGA,SAAS,CAACqD,MAAM,CAACC,CAAC,EAAIA,CAAC,GAAKzB,QAAQ,CAAC,CACnD,CAEA;AACA;AACA,GACA,MAAO,SAAS,CAAA0B,UAAUA,CAAA,CAAG,CAC3Bf,aAAa,CAAC,CAAC,CACf,GAAIvC,cAAc,CAAE,CAClBuD,YAAY,CAACvD,cAAc,CAAC,CAC5BA,cAAc,CAAG,IAAI,CACvB,CACA,GAAIF,EAAE,CAAE,CACN,GAAI,CACFA,EAAE,CAAC0D,KAAK,CAAC,CAAC,CACZ,CAAE,MAAO1B,CAAC,CAAE,CACVZ,OAAO,CAACa,KAAK,CAAC,uBAAuB,CAAED,CAAC,CAAC,CAC3C,CACAhC,EAAE,CAAG,IAAI,CACX,CACAC,SAAS,CAAG,EAAE,CACdG,WAAW,CAAG,KAAK,CACnBC,YAAY,CAAG,KAAK,CACpBC,eAAe,CAAG,EAAE,CACpBC,iBAAiB,CAAG,CAAC,CACvB,CAEA;AACA;AACA,GACA,MAAO,SAAS,CAAAoD,oBAAoBA,CAAA,CAAG,CACrC,MAAO,CAAAvD,WAAW,CACpB,CAEA;AACA;AACA,GACA,MAAO,SAAS,CAAAwD,qBAAqBA,CAAA,CAAG,CACtC,MAAO,CAAAvD,YAAY,CACrB,CAEA;AACA;AACA,GACA,MAAO,SAAS,CAAAwD,oBAAoBA,CAAA,CAAG,CACrC,MAAO,CAAAtD,iBAAiB,CAC1B","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}