{"ast":null,"code":"var _jsxFileName = \"C:\\\\Users\\\\Vladislav\\\\Documents\\\\GitHub\\\\aist-messenger\\\\src\\\\context\\\\CallContext.jsx\",\n  _s = $RefreshSig$(),\n  _s2 = $RefreshSig$();\nimport React, { createContext, useContext, useState, useRef, useEffect, useCallback } from 'react';\nimport { getWsUrl } from '../lib/api';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst CallContext = /*#__PURE__*/createContext(null);\nexport function useCall() {\n  _s();\n  const ctx = useContext(CallContext);\n  return ctx;\n}\n_s(useCall, \"/dMy7t63NXD4eYACoT93CePwGrg=\");\nexport function CallProvider({\n  children\n}) {\n  _s2();\n  const [wsReady, setWsReady] = useState(false);\n  const [incomingCall, setIncomingCall] = useState(null);\n  const wsRef = useRef(null);\n  const messageReceiverRef = useRef(null);\n  const wsUrl = getWsUrl();\n  const token = typeof localStorage !== 'undefined' ? localStorage.getItem('aist_token') : null;\n  const send = useCallback((event, payload) => {\n    const ws = wsRef.current;\n    if (ws && ws.readyState === 1) {\n      try {\n        ws.send(JSON.stringify({\n          event,\n          payload: payload || {}\n        }));\n      } catch {}\n    }\n  }, []);\n  const rejectCall = useCallback(() => {\n    if (incomingCall) {\n      send('call:hangup');\n      setIncomingCall(null);\n    }\n  }, [incomingCall, send]);\n  const acceptCall = useCallback(() => {\n    const data = incomingCall;\n    setIncomingCall(null);\n    return data;\n  }, [incomingCall]);\n  useEffect(() => {\n    if (!wsUrl || !token) return;\n    const base = wsUrl.startsWith('ws') ? wsUrl : wsUrl.replace(/^https?/, s => s === 'https' ? 'wss' : 'ws');\n    const url = `${base}?token=${encodeURIComponent(token)}`;\n    let ws = null;\n    try {\n      ws = new WebSocket(url);\n      wsRef.current = ws;\n      ws.onopen = () => setWsReady(true);\n      ws.onmessage = ev => {\n        try {\n          const msg = JSON.parse(ev.data);\n          if (msg.event === 'call:offer') {\n            const p = msg.payload || {};\n            setIncomingCall({\n              fromUserId: p.fromUserId,\n              sdp: p.sdp,\n              isVideo: !!p.isVideo\n            });\n            return;\n          }\n          const recv = messageReceiverRef.current;\n          if (recv) recv(msg);\n        } catch {}\n      };\n      ws.onclose = () => setWsReady(false);\n      ws.onerror = () => setWsReady(false);\n    } catch (e) {}\n    return () => {\n      if (ws && ws.readyState === WebSocket.OPEN) ws.close();\n      wsRef.current = null;\n      setWsReady(false);\n    };\n  }, [wsUrl, token]);\n  const setMessageReceiver = useCallback(fn => {\n    messageReceiverRef.current = fn;\n  }, []);\n  const value = {\n    wsRef,\n    wsReady,\n    send,\n    incomingCall,\n    setIncomingCall,\n    rejectCall,\n    acceptCall,\n    setMessageReceiver\n  };\n  return /*#__PURE__*/_jsxDEV(CallContext.Provider, {\n    value: value,\n    children: children\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 92,\n    columnNumber: 10\n  }, this);\n}\n_s2(CallProvider, \"zr2EZfm5sJispOZQGDlGCXtR/3M=\");\n_c = CallProvider;\nvar _c;\n$RefreshReg$(_c, \"CallProvider\");","map":{"version":3,"names":["React","createContext","useContext","useState","useRef","useEffect","useCallback","getWsUrl","jsxDEV","_jsxDEV","CallContext","useCall","_s","ctx","CallProvider","children","_s2","wsReady","setWsReady","incomingCall","setIncomingCall","wsRef","messageReceiverRef","wsUrl","token","localStorage","getItem","send","event","payload","ws","current","readyState","JSON","stringify","rejectCall","acceptCall","data","base","startsWith","replace","s","url","encodeURIComponent","WebSocket","onopen","onmessage","ev","msg","parse","p","fromUserId","sdp","isVideo","recv","onclose","onerror","e","OPEN","close","setMessageReceiver","fn","value","Provider","fileName","_jsxFileName","lineNumber","columnNumber","_c","$RefreshReg$"],"sources":["C:/Users/Vladislav/Documents/GitHub/aist-messenger/src/context/CallContext.jsx"],"sourcesContent":["import React, { createContext, useContext, useState, useRef, useEffect, useCallback } from 'react';\r\nimport { getWsUrl } from '../lib/api';\r\n\r\nconst CallContext = createContext(null);\r\n\r\nexport function useCall() {\r\n  const ctx = useContext(CallContext);\r\n  return ctx;\r\n}\r\n\r\nexport function CallProvider({ children }) {\r\n  const [wsReady, setWsReady] = useState(false);\r\n  const [incomingCall, setIncomingCall] = useState(null);\r\n  const wsRef = useRef(null);\r\n  const messageReceiverRef = useRef(null);\r\n\r\n  const wsUrl = getWsUrl();\r\n  const token = typeof localStorage !== 'undefined' ? localStorage.getItem('aist_token') : null;\r\n\r\n  const send = useCallback((event, payload) => {\r\n    const ws = wsRef.current;\r\n    if (ws && ws.readyState === 1) {\r\n      try {\r\n        ws.send(JSON.stringify({ event, payload: payload || {} }));\r\n      } catch {}\r\n    }\r\n  }, []);\r\n\r\n  const rejectCall = useCallback(() => {\r\n    if (incomingCall) {\r\n      send('call:hangup');\r\n      setIncomingCall(null);\r\n    }\r\n  }, [incomingCall, send]);\r\n\r\n  const acceptCall = useCallback(() => {\r\n    const data = incomingCall;\r\n    setIncomingCall(null);\r\n    return data;\r\n  }, [incomingCall]);\r\n\r\n  useEffect(() => {\r\n    if (!wsUrl || !token) return;\r\n    const base = wsUrl.startsWith('ws') ? wsUrl : wsUrl.replace(/^https?/, (s) => (s === 'https' ? 'wss' : 'ws'));\r\n    const url = `${base}?token=${encodeURIComponent(token)}`;\r\n    let ws = null;\r\n    try {\r\n      ws = new WebSocket(url);\r\n      wsRef.current = ws;\r\n      ws.onopen = () => setWsReady(true);\r\n      ws.onmessage = (ev) => {\r\n        try {\r\n          const msg = JSON.parse(ev.data);\r\n          if (msg.event === 'call:offer') {\r\n            const p = msg.payload || {};\r\n            setIncomingCall({\r\n              fromUserId: p.fromUserId,\r\n              sdp: p.sdp,\r\n              isVideo: !!p.isVideo,\r\n            });\r\n            return;\r\n          }\r\n          const recv = messageReceiverRef.current;\r\n          if (recv) recv(msg);\r\n        } catch {}\r\n      };\r\n      ws.onclose = () => setWsReady(false);\r\n      ws.onerror = () => setWsReady(false);\r\n    } catch (e) {}\r\n    return () => {\r\n      if (ws && ws.readyState === WebSocket.OPEN) ws.close();\r\n      wsRef.current = null;\r\n      setWsReady(false);\r\n    };\r\n  }, [wsUrl, token]);\r\n\r\n  const setMessageReceiver = useCallback((fn) => {\r\n    messageReceiverRef.current = fn;\r\n  }, []);\r\n\r\n  const value = {\r\n    wsRef,\r\n    wsReady,\r\n    send,\r\n    incomingCall,\r\n    setIncomingCall,\r\n    rejectCall,\r\n    acceptCall,\r\n    setMessageReceiver,\r\n  };\r\n\r\n  return <CallContext.Provider value={value}>{children}</CallContext.Provider>;\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}