{"ast":null,"code":"/**\n * WebSocket для получения сообщений в реальном времени\n */import{getWsUrl}from'./api';let ws=null;let listeners=[];let reconnectTimer=null;let isConnected=false;let pendingMessages=[];/**\n * Подключиться к WebSocket\n */export function connectChatWebSocket(token,onMessage){if(ws){// Если уже подключены, добавляем слушателя\nif(onMessage)listeners.push(onMessage);return;}const url=\"\".concat(getWsUrl(),\"?token=\").concat(encodeURIComponent(token));ws=new WebSocket(url);ws.onopen=()=>{console.log('[ChatWS] Connected');isConnected=true;// Отправляем отложенные сообщения\npendingMessages.forEach(msg=>send(msg));pendingMessages=[];};ws.onmessage=event=>{try{const data=JSON.parse(event.data);console.log('[ChatWS] Received:',data);// Оповещаем всех слушателей\nlisteners.forEach(listener=>listener(data));}catch(e){console.error('[ChatWS] Error parsing message:',e);}};ws.onclose=()=>{console.log('[ChatWS] Disconnected');isConnected=false;ws=null;// Автоматическое переподключение через 5 секунд\nreconnectTimer=setTimeout(()=>{const newToken=localStorage.getItem('aist_token');if(newToken)connectChatWebSocket(newToken);},5000);};ws.onerror=error=>{console.error('[ChatWS] Error:',error);};if(onMessage)listeners.push(onMessage);}/**\n * Отправить сообщение через WebSocket\n */export function send(data){if(!ws||!isConnected){pendingMessages.push(data);return;}ws.send(JSON.stringify(data));}/**\n * Добавить слушателя сообщений\n */export function addListener(listener){listeners.push(listener);}/**\n * Удалить слушателя сообщений\n */export function removeListener(listener){listeners=listeners.filter(l=>l!==listener);}/**\n * Отключиться от WebSocket\n */export function disconnect(){if(reconnectTimer){clearTimeout(reconnectTimer);reconnectTimer=null;}if(ws){ws.close();ws=null;}listeners=[];isConnected=false;pendingMessages=[];}/**\n * Проверить, подключен ли WebSocket\n */export function isWebSocketConnected(){return isConnected;}","map":{"version":3,"names":["getWsUrl","ws","listeners","reconnectTimer","isConnected","pendingMessages","connectChatWebSocket","token","onMessage","push","url","concat","encodeURIComponent","WebSocket","onopen","console","log","forEach","msg","send","onmessage","event","data","JSON","parse","listener","e","error","onclose","setTimeout","newToken","localStorage","getItem","onerror","stringify","addListener","removeListener","filter","l","disconnect","clearTimeout","close","isWebSocketConnected"],"sources":["C:/Users/Vladislav/Documents/GitHub/aist-messenger/src/lib/chatWebSocket.js"],"sourcesContent":["/**\n * WebSocket для получения сообщений в реальном времени\n */\nimport { getWsUrl } from './api';\n\nlet ws = null;\nlet listeners = [];\nlet reconnectTimer = null;\nlet isConnected = false;\nlet pendingMessages = [];\n\n/**\n * Подключиться к WebSocket\n */\nexport function connectChatWebSocket(token, onMessage) {\n  if (ws) {\n    // Если уже подключены, добавляем слушателя\n    if (onMessage) listeners.push(onMessage);\n    return;\n  }\n\n  const url = `${getWsUrl()}?token=${encodeURIComponent(token)}`;\n\n  ws = new WebSocket(url);\n\n  ws.onopen = () => {\n    console.log('[ChatWS] Connected');\n    isConnected = true;\n    // Отправляем отложенные сообщения\n    pendingMessages.forEach(msg => send(msg));\n    pendingMessages = [];\n  };\n\n  ws.onmessage = (event) => {\n    try {\n      const data = JSON.parse(event.data);\n      console.log('[ChatWS] Received:', data);\n\n      // Оповещаем всех слушателей\n      listeners.forEach(listener => listener(data));\n    } catch (e) {\n      console.error('[ChatWS] Error parsing message:', e);\n    }\n  };\n\n  ws.onclose = () => {\n    console.log('[ChatWS] Disconnected');\n    isConnected = false;\n    ws = null;\n    // Автоматическое переподключение через 5 секунд\n    reconnectTimer = setTimeout(() => {\n      const newToken = localStorage.getItem('aist_token');\n      if (newToken) connectChatWebSocket(newToken);\n    }, 5000);\n  };\n\n  ws.onerror = (error) => {\n    console.error('[ChatWS] Error:', error);\n  };\n\n  if (onMessage) listeners.push(onMessage);\n}\n\n/**\n * Отправить сообщение через WebSocket\n */\nexport function send(data) {\n  if (!ws || !isConnected) {\n    pendingMessages.push(data);\n    return;\n  }\n  ws.send(JSON.stringify(data));\n}\n\n/**\n * Добавить слушателя сообщений\n */\nexport function addListener(listener) {\n  listeners.push(listener);\n}\n\n/**\n * Удалить слушателя сообщений\n */\nexport function removeListener(listener) {\n  listeners = listeners.filter(l => l !== listener);\n}\n\n/**\n * Отключиться от WebSocket\n */\nexport function disconnect() {\n  if (reconnectTimer) {\n    clearTimeout(reconnectTimer);\n    reconnectTimer = null;\n  }\n  if (ws) {\n    ws.close();\n    ws = null;\n  }\n  listeners = [];\n  isConnected = false;\n  pendingMessages = [];\n}\n\n/**\n * Проверить, подключен ли WebSocket\n */\nexport function isWebSocketConnected() {\n  return isConnected;\n}\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}