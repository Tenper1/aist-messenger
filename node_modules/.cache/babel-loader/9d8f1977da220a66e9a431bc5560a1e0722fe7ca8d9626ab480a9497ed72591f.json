{"ast":null,"code":"var _window$location;\n/**\r\n * API для синхронизации чатов и сообщений. Один аккаунт (телефон) — одни чаты на всех устройствах.\r\n */\n\nconst API_BASE = process.env.REACT_APP_API_URL || (typeof window !== 'undefined' && ((_window$location = window.location) === null || _window$location === void 0 ? void 0 : _window$location.hostname) === 'localhost' ? 'http://localhost:3001' : 'https://api.get-aist.ru');\n\n/** URL WebSocket для звонков: тот же хост что и API, путь /ws */\nexport function getWsUrl() {\n  if (process.env.REACT_APP_WS_URL) return process.env.REACT_APP_WS_URL;\n  const base = API_BASE.replace(/^https?/, s => s === 'https' ? 'wss' : 'ws');\n  return `${base.replace(/\\/$/, '')}/ws`;\n}\nfunction getToken() {\n  try {\n    return localStorage.getItem('aist_token') || null;\n  } catch {\n    return null;\n  }\n}\nasync function request(method, path, body = null) {\n  const token = getToken();\n  const opts = {\n    method,\n    headers: {\n      'Content-Type': 'application/json'\n    }\n  };\n  if (token) opts.headers.Authorization = `Bearer ${token}`;\n  if (body != null) opts.body = JSON.stringify(body);\n  const res = await fetch(`${API_BASE}${path}`, opts);\n  let json = null;\n  try {\n    const text = await res.text();\n    if (text) json = JSON.parse(text);\n  } catch {}\n  if (!res.ok) {\n    const err = new Error(json && (json.message || json.error) || res.statusText || 'Request failed');\n    err.status = res.status;\n    err.payload = json;\n    throw err;\n  }\n  if (res.status === 204) return null;\n  return json || {};\n}\n\n/** Список чатов с сервера (по userId из токена). При ошибке или без токена — null. */\nexport async function apiGetChats() {\n  if (!getToken()) return null;\n  try {\n    return await request('GET', '/api/chats');\n  } catch {\n    return null;\n  }\n}\n\n/** Сообщения чата с сервера. При ошибке — null. */\nexport async function apiGetMessages(chatId) {\n  if (!getToken() || !chatId) return null;\n  try {\n    const list = await request('GET', `/api/chats/${encodeURIComponent(chatId)}/messages`);\n    return Array.isArray(list) ? list : null;\n  } catch {\n    return null;\n  }\n}\n\n/** Отправить сообщение на сервер. Возвращает созданное сообщение или null при ошибке. */\nexport async function apiSendMessage(chatId, {\n  text,\n  attachment\n}) {\n  if (!getToken() || !chatId) return null;\n  try {\n    return await request('POST', `/api/chats/${encodeURIComponent(chatId)}/messages`, {\n      text: text || '',\n      attachment: attachment || null\n    });\n  } catch (e) {\n    if ((e === null || e === void 0 ? void 0 : e.status) === 404) console.warn('Chat not found on server:', chatId);\n    return null;\n  }\n}\n\n/** Создать чат на сервере. Возвращает чат или null. Для личного чата передайте peerUsername или peerUserId. */\nexport async function apiCreateChat(payload) {\n  if (!getToken()) return null;\n  try {\n    return await request('POST', '/api/chats', {\n      name: payload.name || 'Чат',\n      type: payload.type || 'user',\n      photo: payload.photo || null,\n      peerUsername: payload.peerUsername || null,\n      peerUserId: payload.peerUserId || null,\n      description: payload.description || null,\n      shareLink: payload.shareLink || null,\n      admins: payload.admins || [],\n      moderators: payload.moderators || []\n    });\n  } catch {\n    return null;\n  }\n}\n\n/** Получить публичный ключ пользователя */\nexport async function apiGetPublicKey(userId) {\n  if (!getToken() || !userId) return null;\n  try {\n    const res = await request('GET', `/api/users/${encodeURIComponent(userId)}/public-key`);\n    return (res === null || res === void 0 ? void 0 : res.publicKey) || null;\n  } catch {\n    return null;\n  }\n}\n\n/** Сохранить свой публичный ключ на сервере */\nexport async function apiSetPublicKey(publicKeyPem) {\n  if (!getToken()) return null;\n  try {\n    return await request('POST', '/api/profile/public-key', {\n      publicKey: publicKeyPem\n    });\n  } catch {\n    return null;\n  }\n}","map":{"version":3,"names":["API_BASE","process","env","REACT_APP_API_URL","window","_window$location","location","hostname","getWsUrl","REACT_APP_WS_URL","base","replace","s","getToken","localStorage","getItem","request","method","path","body","token","opts","headers","Authorization","JSON","stringify","res","fetch","json","text","parse","ok","err","Error","message","error","statusText","status","payload","apiGetChats","apiGetMessages","chatId","list","encodeURIComponent","Array","isArray","apiSendMessage","attachment","e","console","warn","apiCreateChat","name","type","photo","peerUsername","peerUserId","description","shareLink","admins","moderators","apiGetPublicKey","userId","publicKey","apiSetPublicKey","publicKeyPem"],"sources":["C:/Users/Vladislav/Documents/GitHub/aist-messenger/src/lib/api.js"],"sourcesContent":["/**\r\n * API для синхронизации чатов и сообщений. Один аккаунт (телефон) — одни чаты на всех устройствах.\r\n */\r\n\r\nconst API_BASE = process.env.REACT_APP_API_URL || (typeof window !== 'undefined' && window.location?.hostname === 'localhost' ? 'http://localhost:3001' : 'https://api.get-aist.ru');\r\n\r\n/** URL WebSocket для звонков: тот же хост что и API, путь /ws */\r\nexport function getWsUrl() {\r\n  if (process.env.REACT_APP_WS_URL) return process.env.REACT_APP_WS_URL;\r\n  const base = API_BASE.replace(/^https?/, (s) => (s === 'https' ? 'wss' : 'ws'));\r\n  return `${base.replace(/\\/$/, '')}/ws`;\r\n}\r\n\r\nfunction getToken() {\r\n  try {\r\n    return localStorage.getItem('aist_token') || null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\nasync function request(method, path, body = null) {\r\n  const token = getToken();\r\n  const opts = {\r\n    method,\r\n    headers: { 'Content-Type': 'application/json' },\r\n  };\r\n  if (token) opts.headers.Authorization = `Bearer ${token}`;\r\n  if (body != null) opts.body = JSON.stringify(body);\r\n  const res = await fetch(`${API_BASE}${path}`, opts);\r\n  let json = null;\r\n  try {\r\n    const text = await res.text();\r\n    if (text) json = JSON.parse(text);\r\n  } catch {}\r\n  if (!res.ok) {\r\n    const err = new Error((json && (json.message || json.error)) || res.statusText || 'Request failed');\r\n    err.status = res.status;\r\n    err.payload = json;\r\n    throw err;\r\n  }\r\n  if (res.status === 204) return null;\r\n  return json || {};\r\n}\r\n\r\n/** Список чатов с сервера (по userId из токена). При ошибке или без токена — null. */\r\nexport async function apiGetChats() {\r\n  if (!getToken()) return null;\r\n  try {\r\n    return await request('GET', '/api/chats');\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/** Сообщения чата с сервера. При ошибке — null. */\r\nexport async function apiGetMessages(chatId) {\r\n  if (!getToken() || !chatId) return null;\r\n  try {\r\n    const list = await request('GET', `/api/chats/${encodeURIComponent(chatId)}/messages`);\r\n    return Array.isArray(list) ? list : null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/** Отправить сообщение на сервер. Возвращает созданное сообщение или null при ошибке. */\r\nexport async function apiSendMessage(chatId, { text, attachment }) {\r\n  if (!getToken() || !chatId) return null;\r\n  try {\r\n    return await request('POST', `/api/chats/${encodeURIComponent(chatId)}/messages`, { text: text || '', attachment: attachment || null });\r\n  } catch (e) {\r\n    if (e?.status === 404) console.warn('Chat not found on server:', chatId);\r\n    return null;\r\n  }\r\n}\r\n\r\n/** Создать чат на сервере. Возвращает чат или null. Для личного чата передайте peerUsername или peerUserId. */\r\nexport async function apiCreateChat(payload) {\r\n  if (!getToken()) return null;\r\n  try {\r\n    return await request('POST', '/api/chats', {\r\n      name: payload.name || 'Чат',\r\n      type: payload.type || 'user',\r\n      photo: payload.photo || null,\r\n      peerUsername: payload.peerUsername || null,\r\n      peerUserId: payload.peerUserId || null,\r\n      description: payload.description || null,\r\n      shareLink: payload.shareLink || null,\r\n      admins: payload.admins || [],\r\n      moderators: payload.moderators || [],\r\n    });\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/** Получить публичный ключ пользователя */\r\nexport async function apiGetPublicKey(userId) {\r\n  if (!getToken() || !userId) return null;\r\n  try {\r\n    const res = await request('GET', `/api/users/${encodeURIComponent(userId)}/public-key`);\r\n    return res?.publicKey || null;\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n/** Сохранить свой публичный ключ на сервере */\r\nexport async function apiSetPublicKey(publicKeyPem) {\r\n  if (!getToken()) return null;\r\n  try {\r\n    return await request('POST', '/api/profile/public-key', { publicKey: publicKeyPem });\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}