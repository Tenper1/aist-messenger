{"ast":null,"code":"import React,{createContext,useContext,useState,useRef,useEffect,useCallback}from'react';import{getWsUrl}from'../lib/api';import{jsx as _jsx}from\"react/jsx-runtime\";const CallContext=/*#__PURE__*/createContext(null);export function useCall(){const ctx=useContext(CallContext);return ctx;}export function CallProvider(_ref){let{children}=_ref;const[wsReady,setWsReady]=useState(false);const[incomingCall,setIncomingCall]=useState(null);const wsRef=useRef(null);const messageReceiverRef=useRef(null);const wsUrl=getWsUrl();const token=typeof localStorage!=='undefined'?localStorage.getItem('aist_token'):null;const send=useCallback((event,payload)=>{const ws=wsRef.current;if(ws&&ws.readyState===1){try{ws.send(JSON.stringify({event,payload:payload||{}}));}catch(_unused){}}},[]);const rejectCall=useCallback(()=>{if(incomingCall){send('call:hangup');setIncomingCall(null);}},[incomingCall,send]);const acceptCall=useCallback(()=>{const data=incomingCall;setIncomingCall(null);return data;},[incomingCall]);useEffect(()=>{if(!wsUrl||!token)return;const base=wsUrl.startsWith('ws')?wsUrl:wsUrl.replace(/^https?/,s=>s==='https'?'wss':'ws');const url=\"\".concat(base,\"?token=\").concat(encodeURIComponent(token));let ws=null;try{ws=new WebSocket(url);wsRef.current=ws;ws.onopen=()=>setWsReady(true);ws.onmessage=ev=>{try{const msg=JSON.parse(ev.data);if(msg.event==='call:offer'){const p=msg.payload||{};setIncomingCall({fromUserId:p.fromUserId,sdp:p.sdp,isVideo:!!p.isVideo});return;}const recv=messageReceiverRef.current;if(recv)recv(msg);}catch(_unused2){}};ws.onclose=()=>setWsReady(false);ws.onerror=()=>setWsReady(false);}catch(e){}return()=>{if(ws&&ws.readyState===WebSocket.OPEN)ws.close();wsRef.current=null;setWsReady(false);};},[wsUrl,token]);const setMessageReceiver=useCallback(fn=>{messageReceiverRef.current=fn;},[]);const value={wsRef,wsReady,send,incomingCall,setIncomingCall,rejectCall,acceptCall,setMessageReceiver};return/*#__PURE__*/_jsx(CallContext.Provider,{value:value,children:children});}","map":{"version":3,"names":["React","createContext","useContext","useState","useRef","useEffect","useCallback","getWsUrl","jsx","_jsx","CallContext","useCall","ctx","CallProvider","_ref","children","wsReady","setWsReady","incomingCall","setIncomingCall","wsRef","messageReceiverRef","wsUrl","token","localStorage","getItem","send","event","payload","ws","current","readyState","JSON","stringify","_unused","rejectCall","acceptCall","data","base","startsWith","replace","s","url","concat","encodeURIComponent","WebSocket","onopen","onmessage","ev","msg","parse","p","fromUserId","sdp","isVideo","recv","_unused2","onclose","onerror","e","OPEN","close","setMessageReceiver","fn","value","Provider"],"sources":["C:/Users/Vladislav/Documents/GitHub/aist-messenger/src/context/CallContext.jsx"],"sourcesContent":["import React, { createContext, useContext, useState, useRef, useEffect, useCallback } from 'react';\r\nimport { getWsUrl } from '../lib/api';\r\n\r\nconst CallContext = createContext(null);\r\n\r\nexport function useCall() {\r\n  const ctx = useContext(CallContext);\r\n  return ctx;\r\n}\r\n\r\nexport function CallProvider({ children }) {\r\n  const [wsReady, setWsReady] = useState(false);\r\n  const [incomingCall, setIncomingCall] = useState(null);\r\n  const wsRef = useRef(null);\r\n  const messageReceiverRef = useRef(null);\r\n\r\n  const wsUrl = getWsUrl();\r\n  const token = typeof localStorage !== 'undefined' ? localStorage.getItem('aist_token') : null;\r\n\r\n  const send = useCallback((event, payload) => {\r\n    const ws = wsRef.current;\r\n    if (ws && ws.readyState === 1) {\r\n      try {\r\n        ws.send(JSON.stringify({ event, payload: payload || {} }));\r\n      } catch {}\r\n    }\r\n  }, []);\r\n\r\n  const rejectCall = useCallback(() => {\r\n    if (incomingCall) {\r\n      send('call:hangup');\r\n      setIncomingCall(null);\r\n    }\r\n  }, [incomingCall, send]);\r\n\r\n  const acceptCall = useCallback(() => {\r\n    const data = incomingCall;\r\n    setIncomingCall(null);\r\n    return data;\r\n  }, [incomingCall]);\r\n\r\n  useEffect(() => {\r\n    if (!wsUrl || !token) return;\r\n    const base = wsUrl.startsWith('ws') ? wsUrl : wsUrl.replace(/^https?/, (s) => (s === 'https' ? 'wss' : 'ws'));\r\n    const url = `${base}?token=${encodeURIComponent(token)}`;\r\n    let ws = null;\r\n    try {\r\n      ws = new WebSocket(url);\r\n      wsRef.current = ws;\r\n      ws.onopen = () => setWsReady(true);\r\n      ws.onmessage = (ev) => {\r\n        try {\r\n          const msg = JSON.parse(ev.data);\r\n          if (msg.event === 'call:offer') {\r\n            const p = msg.payload || {};\r\n            setIncomingCall({\r\n              fromUserId: p.fromUserId,\r\n              sdp: p.sdp,\r\n              isVideo: !!p.isVideo,\r\n            });\r\n            return;\r\n          }\r\n          const recv = messageReceiverRef.current;\r\n          if (recv) recv(msg);\r\n        } catch {}\r\n      };\r\n      ws.onclose = () => setWsReady(false);\r\n      ws.onerror = () => setWsReady(false);\r\n    } catch (e) {}\r\n    return () => {\r\n      if (ws && ws.readyState === WebSocket.OPEN) ws.close();\r\n      wsRef.current = null;\r\n      setWsReady(false);\r\n    };\r\n  }, [wsUrl, token]);\r\n\r\n  const setMessageReceiver = useCallback((fn) => {\r\n    messageReceiverRef.current = fn;\r\n  }, []);\r\n\r\n  const value = {\r\n    wsRef,\r\n    wsReady,\r\n    send,\r\n    incomingCall,\r\n    setIncomingCall,\r\n    rejectCall,\r\n    acceptCall,\r\n    setMessageReceiver,\r\n  };\r\n\r\n  return <CallContext.Provider value={value}>{children}</CallContext.Provider>;\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}