{"ast":null,"code":"import React,{useState,useEffect,useRef}from'react';import{useTheme}from'../context/ThemeContext';import{useCall}from'../context/CallContext';import{getWsUrl}from'../lib/api';import{IconBack,IconMic,IconMicOff,IconSpeaker,IconKeypad}from'./Icons';import{jsx as _jsx,jsxs as _jsxs,Fragment as _Fragment}from\"react/jsx-runtime\";export default function CallScreen(_ref){var _callCtx$wsReady;let{peerName,isVideo,onEnd,peerUserId,isIncoming=false,remoteOffer=null}=_ref;const{theme}=useTheme();const callCtx=useCall();const[localStream,setLocalStream]=useState(null);const[remoteStream,setRemoteStream]=useState(null);const[muted,setMuted]=useState(false);const[speaker,setSpeaker]=useState(false);const[showKeypad,setShowKeypad]=useState(false);const[error,setError]=useState(null);const[status,setStatus]=useState(isIncoming?'connecting':'calling');const[wsOpen,setWsOpen]=useState(false);const localRef=useRef(null);const remoteRef=useRef(null);const pcRef=useRef(null);const wsRef=useRef(null);const offerSentRef=useRef(false);const useSharedWs=isIncoming&&!!callCtx;const useCtxForOutgoing=!isIncoming&&!!(callCtx!==null&&callCtx!==void 0&&callCtx.wsReady)&&!!(callCtx!==null&&callCtx!==void 0&&callCtx.send);const effectiveWsOpen=useSharedWs||useCtxForOutgoing?(_callCtx$wsReady=callCtx===null||callCtx===void 0?void 0:callCtx.wsReady)!==null&&_callCtx$wsReady!==void 0?_callCtx$wsReady:false:wsOpen;useEffect(()=>{const wantVideo=!!isVideo;let stream=null;navigator.mediaDevices.getUserMedia({video:wantVideo,audio:true}).then(s=>{stream=s;setLocalStream(s);if(muted)s.getAudioTracks().forEach(t=>t.enabled=false);}).catch(e=>setError('Нет доступа к камере или микрофону'));return()=>{if(stream)stream.getTracks().forEach(t=>t.stop());};},[isVideo]);useEffect(()=>{if(!localRef.current||!localStream)return;localRef.current.srcObject=localStream;},[localStream]);useEffect(()=>{if(!remoteRef.current||!remoteStream)return;remoteRef.current.srcObject=remoteStream;},[remoteStream]);useEffect(()=>{if(remoteRef.current)remoteRef.current.volume=speaker?1:0.6;},[speaker,remoteStream]);useEffect(()=>{if(muted&&localStream)localStream.getAudioTracks().forEach(t=>t.enabled=false);if(!muted&&localStream)localStream.getAudioTracks().forEach(t=>t.enabled=true);},[muted,localStream]);const wsUrl=getWsUrl();const token=typeof localStorage!=='undefined'?localStorage.getItem('aist_token'):null;useEffect(()=>{if(useSharedWs||useCtxForOutgoing)return;if(!peerUserId||!wsUrl||!token)return;setWsOpen(false);const base=wsUrl.startsWith('ws')?wsUrl:wsUrl.replace(/^https?/,s=>s==='https'?'wss':'ws');const url=\"\".concat(base,\"?token=\").concat(encodeURIComponent(token));let ws=null;try{ws=new WebSocket(url);wsRef.current=ws;ws.onopen=()=>setWsOpen(true);ws.onmessage=ev=>{try{var _msg$payload,_msg$payload4;const msg=JSON.parse(ev.data);if(msg.event==='call:answer'&&((_msg$payload=msg.payload)!==null&&_msg$payload!==void 0&&_msg$payload.sdp||msg.payload)){var _msg$payload2,_msg$payload3;setStatus('connected');const desc=(_msg$payload2=msg.payload)!==null&&_msg$payload2!==void 0&&_msg$payload2.type?msg.payload:{type:'answer',sdp:((_msg$payload3=msg.payload)===null||_msg$payload3===void 0?void 0:_msg$payload3.sdp)||msg.payload};if(pcRef.current)pcRef.current.setRemoteDescription(new RTCSessionDescription(desc)).catch(()=>{});}if(msg.event==='call:ice'&&(_msg$payload4=msg.payload)!==null&&_msg$payload4!==void 0&&_msg$payload4.candidate){if(pcRef.current)pcRef.current.addIceCandidate(new RTCIceCandidate(msg.payload.candidate)).catch(()=>{});}if(msg.event==='call:hangup')onEnd();}catch(_unused){}};ws.onerror=()=>setError('Ошибка соединения');ws.onclose=()=>setWsOpen(false);}catch(e){setError('WebSocket недоступен');}return()=>{if(pcRef.current){pcRef.current.close();pcRef.current=null;}if(ws&&ws.readyState===WebSocket.OPEN)ws.close();wsRef.current=null;setWsOpen(false);offerSentRef.current=false;};},[useSharedWs,useCtxForOutgoing,peerUserId,wsUrl,token,onEnd]);useEffect(()=>{if(useSharedWs&&callCtx&&isIncoming&&remoteOffer&&localStream){callCtx.setMessageReceiver(msg=>{var _msg$payload5;if(msg.event==='call:ice'&&(_msg$payload5=msg.payload)!==null&&_msg$payload5!==void 0&&_msg$payload5.candidate&&pcRef.current){pcRef.current.addIceCandidate(new RTCIceCandidate(msg.payload.candidate)).catch(()=>{});}if(msg.event==='call:hangup')onEnd();});return()=>callCtx.setMessageReceiver(null);}},[useSharedWs,isIncoming,remoteOffer,localStream,callCtx,onEnd]);useEffect(()=>{if(!localStream||!peerUserId)return;if(isIncoming&&remoteOffer&&callCtx!==null&&callCtx!==void 0&&callCtx.wsReady&&callCtx.send){const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});pcRef.current=pc;localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));pc.ontrack=e=>setRemoteStream(e.streams[0]||e.stream);pc.onicecandidate=e=>{if(e.candidate&&callCtx!==null&&callCtx!==void 0&&callCtx.send)callCtx.send('call:ice',{candidate:e.candidate});};pc.setRemoteDescription(new RTCSessionDescription(remoteOffer)).then(()=>pc.createAnswer()).then(answer=>pc.setLocalDescription(answer).then(()=>answer)).then(answer=>{callCtx.send('call:answer',{sdp:answer});setStatus('connected');}).catch(()=>setError('Ошибка соединения'));return()=>{pc.close();pcRef.current=null;};}const sendOffer=offer=>{var _wsRef$current;if(useCtxForOutgoing&&callCtx!==null&&callCtx!==void 0&&callCtx.send){callCtx.send('call:offer',{userId:peerUserId,targetUserId:peerUserId,sdp:offer,isVideo:!!isVideo});offerSentRef.current=true;}else if(((_wsRef$current=wsRef.current)===null||_wsRef$current===void 0?void 0:_wsRef$current.readyState)===WebSocket.OPEN){wsRef.current.send(JSON.stringify({event:'call:offer',payload:{userId:peerUserId,targetUserId:peerUserId,sdp:offer,isVideo:!!isVideo}}));offerSentRef.current=true;}};if(!isIncoming&&effectiveWsOpen&&!offerSentRef.current&&(wsRef.current||useCtxForOutgoing)){if(useCtxForOutgoing){callCtx.setMessageReceiver(msg=>{var _msg$payload6,_msg$payload9;if(msg.event==='call:answer'&&((_msg$payload6=msg.payload)!==null&&_msg$payload6!==void 0&&_msg$payload6.sdp||msg.payload)){var _msg$payload7,_msg$payload8;setStatus('connected');const desc=(_msg$payload7=msg.payload)!==null&&_msg$payload7!==void 0&&_msg$payload7.type?msg.payload:{type:'answer',sdp:((_msg$payload8=msg.payload)===null||_msg$payload8===void 0?void 0:_msg$payload8.sdp)||msg.payload};if(pcRef.current)pcRef.current.setRemoteDescription(new RTCSessionDescription(desc)).catch(()=>{});}if(msg.event==='call:ice'&&(_msg$payload9=msg.payload)!==null&&_msg$payload9!==void 0&&_msg$payload9.candidate&&pcRef.current){pcRef.current.addIceCandidate(new RTCIceCandidate(msg.payload.candidate)).catch(()=>{});}if(msg.event==='call:hangup')onEnd();});}const pc=new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});pcRef.current=pc;localStream.getTracks().forEach(track=>pc.addTrack(track,localStream));pc.ontrack=e=>setRemoteStream(e.streams[0]||e.stream);pc.onicecandidate=e=>{var _wsRef$current2;if(e.candidate&&useCtxForOutgoing&&callCtx!==null&&callCtx!==void 0&&callCtx.send)callCtx.send('call:ice',{candidate:e.candidate});else if(e.candidate&&((_wsRef$current2=wsRef.current)===null||_wsRef$current2===void 0?void 0:_wsRef$current2.readyState)===WebSocket.OPEN)wsRef.current.send(JSON.stringify({event:'call:ice',payload:{candidate:e.candidate}}));};pc.createOffer().then(offer=>pc.setLocalDescription(offer).then(()=>offer)).then(sendOffer).catch(()=>setError('Ошибка создания предложения'));return()=>{if(useCtxForOutgoing)callCtx.setMessageReceiver(null);if(pcRef.current===pc){pc.close();pcRef.current=null;}offerSentRef.current=false;};}},[localStream,effectiveWsOpen,wsOpen,peerUserId,isIncoming,remoteOffer,callCtx,isVideo,useCtxForOutgoing,onEnd]);const controlBtn=(Icon,active,onClick,label)=>/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:onClick,style:{width:56,height:56,borderRadius:'50%',border:'none',background:active?theme.accent:theme.sidebarBg||'rgba(255,255,255,.12)',color:active?theme.accentText:theme.text,display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer'},title:label,\"aria-label\":label,children:/*#__PURE__*/_jsx(Icon,{width:24,height:24})});const styles={overlay:{position:'fixed',inset:0,background:theme.isDark?'#0c0c0e':'#f5f5f7',zIndex:1000,display:'flex',flexDirection:'column',color:theme.text},header:{padding:'12px 16px',display:'flex',alignItems:'center',gap:12,borderBottom:\"1px solid \".concat(theme.border),background:theme.headerBg},center:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',padding:24},avatar:{width:88,height:88,borderRadius:'50%',background:theme.accent,color:theme.accentText,display:'flex',alignItems:'center',justifyContent:'center',fontSize:36,fontWeight:600,marginBottom:16},name:{fontSize:22,fontWeight:600,marginBottom:4},statusText:{fontSize:15,color:theme.textMuted},remoteVideo:{position:'absolute',inset:0,width:'100%',height:'100%',objectFit:'cover'},localVideo:{position:'absolute',bottom:100,right:16,width:100,height:140,borderRadius:12,objectFit:'cover',border:\"2px solid \".concat(theme.border)},controls:{padding:'24px 16px 32px',paddingBottom:'max(32px, env(safe-area-inset-bottom))',display:'flex',justifyContent:'center',alignItems:'center',gap:28},endBtn:{width:64,height:64,borderRadius:'50%',border:'none',background:'#e53935',color:'#fff',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer'}};return/*#__PURE__*/_jsxs(\"div\",{style:styles.overlay,children:[/*#__PURE__*/_jsxs(\"header\",{style:styles.header,children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",style:{border:'none',background:'transparent',color:theme.accent,padding:8},onClick:onEnd,\"aria-label\":\"\\u041D\\u0430\\u0437\\u0430\\u0434\",children:/*#__PURE__*/_jsx(IconBack,{width:24,height:24})}),/*#__PURE__*/_jsxs(\"span\",{style:{flex:1,fontSize:17,fontWeight:600},children:[isVideo?'Видеозвонок':'Голосовой звонок',\" \\u2014 \",peerName]})]}),/*#__PURE__*/_jsxs(\"div\",{style:{flex:1,position:'relative'},children:[error&&/*#__PURE__*/_jsx(\"div\",{style:{padding:16,textAlign:'center',color:'#e53935'},children:error}),!error&&isVideo&&localStream&&/*#__PURE__*/_jsxs(_Fragment,{children:[remoteStream&&/*#__PURE__*/_jsx(\"video\",{ref:remoteRef,autoPlay:true,playsInline:true,style:styles.remoteVideo}),/*#__PURE__*/_jsx(\"video\",{ref:localRef,autoPlay:true,muted:true,playsInline:true,style:styles.localVideo})]}),!error&&(!isVideo||!localStream)&&/*#__PURE__*/_jsxs(\"div\",{style:styles.center,children:[/*#__PURE__*/_jsx(\"div\",{style:styles.avatar,children:peerName?peerName[0].toUpperCase():'?'}),/*#__PURE__*/_jsx(\"div\",{style:styles.name,children:peerName}),/*#__PURE__*/_jsx(\"div\",{style:styles.statusText,children:status==='connected'?'Разговор':isIncoming?'Подключение...':'Вызов...'})]})]}),/*#__PURE__*/_jsxs(\"div\",{style:styles.controls,children:[controlBtn(muted?IconMicOff:IconMic,muted,()=>setMuted(!muted),muted?'Включить микрофон':'Выключить микрофон'),controlBtn(IconSpeaker,speaker,()=>setSpeaker(!speaker),speaker?'Телефон':'Громкая связь'),controlBtn(IconKeypad,showKeypad,()=>setShowKeypad(!showKeypad),'Клавиатура'),/*#__PURE__*/_jsx(\"button\",{type:\"button\",style:styles.endBtn,onClick:()=>{if(useSharedWs&&callCtx)callCtx.send('call:hangup');onEnd();},title:\"\\u0417\\u0430\\u0432\\u0435\\u0440\\u0448\\u0438\\u0442\\u044C\",\"aria-label\":\"\\u0417\\u0430\\u0432\\u0435\\u0440\\u0448\\u0438\\u0442\\u044C \\u0437\\u0432\\u043E\\u043D\\u043E\\u043A\",children:/*#__PURE__*/_jsx(\"span\",{style:{fontSize:28,lineHeight:1,color:'#fff'},children:\"\\u2715\"})})]})]});}","map":{"version":3,"names":["React","useState","useEffect","useRef","useTheme","useCall","getWsUrl","IconBack","IconMic","IconMicOff","IconSpeaker","IconKeypad","jsx","_jsx","jsxs","_jsxs","Fragment","_Fragment","CallScreen","_ref","_callCtx$wsReady","peerName","isVideo","onEnd","peerUserId","isIncoming","remoteOffer","theme","callCtx","localStream","setLocalStream","remoteStream","setRemoteStream","muted","setMuted","speaker","setSpeaker","showKeypad","setShowKeypad","error","setError","status","setStatus","wsOpen","setWsOpen","localRef","remoteRef","pcRef","wsRef","offerSentRef","useSharedWs","useCtxForOutgoing","wsReady","send","effectiveWsOpen","wantVideo","stream","navigator","mediaDevices","getUserMedia","video","audio","then","s","getAudioTracks","forEach","t","enabled","catch","e","getTracks","stop","current","srcObject","volume","wsUrl","token","localStorage","getItem","base","startsWith","replace","url","concat","encodeURIComponent","ws","WebSocket","onopen","onmessage","ev","_msg$payload","_msg$payload4","msg","JSON","parse","data","event","payload","sdp","_msg$payload2","_msg$payload3","desc","type","setRemoteDescription","RTCSessionDescription","candidate","addIceCandidate","RTCIceCandidate","_unused","onerror","onclose","close","readyState","OPEN","setMessageReceiver","_msg$payload5","pc","RTCPeerConnection","iceServers","urls","track","addTrack","ontrack","streams","onicecandidate","createAnswer","answer","setLocalDescription","sendOffer","offer","_wsRef$current","userId","targetUserId","stringify","_msg$payload6","_msg$payload9","_msg$payload7","_msg$payload8","_wsRef$current2","createOffer","controlBtn","Icon","active","onClick","label","style","width","height","borderRadius","border","background","accent","sidebarBg","color","accentText","text","display","alignItems","justifyContent","cursor","title","children","styles","overlay","position","inset","isDark","zIndex","flexDirection","header","padding","gap","borderBottom","headerBg","center","flex","avatar","fontSize","fontWeight","marginBottom","name","statusText","textMuted","remoteVideo","objectFit","localVideo","bottom","right","controls","paddingBottom","endBtn","textAlign","ref","autoPlay","playsInline","toUpperCase","lineHeight"],"sources":["C:/Users/Vladislav/Documents/GitHub/aist-messenger/src/components/CallScreen.jsx"],"sourcesContent":["import React, { useState, useEffect, useRef } from 'react';\r\nimport { useTheme } from '../context/ThemeContext';\r\nimport { useCall } from '../context/CallContext';\r\nimport { getWsUrl } from '../lib/api';\r\nimport { IconBack, IconMic, IconMicOff, IconSpeaker, IconKeypad } from './Icons';\r\n\r\nexport default function CallScreen({\r\n  peerName,\r\n  isVideo,\r\n  onEnd,\r\n  peerUserId,\r\n  isIncoming = false,\r\n  remoteOffer = null,\r\n}) {\r\n  const { theme } = useTheme();\r\n  const callCtx = useCall();\r\n  const [localStream, setLocalStream] = useState(null);\r\n  const [remoteStream, setRemoteStream] = useState(null);\r\n  const [muted, setMuted] = useState(false);\r\n  const [speaker, setSpeaker] = useState(false);\r\n  const [showKeypad, setShowKeypad] = useState(false);\r\n  const [error, setError] = useState(null);\r\n  const [status, setStatus] = useState(isIncoming ? 'connecting' : 'calling');\r\n  const [wsOpen, setWsOpen] = useState(false);\r\n  const localRef = useRef(null);\r\n  const remoteRef = useRef(null);\r\n  const pcRef = useRef(null);\r\n  const wsRef = useRef(null);\r\n  const offerSentRef = useRef(false);\r\n  const useSharedWs = isIncoming && !!callCtx;\r\n  const useCtxForOutgoing = !isIncoming && !!callCtx?.wsReady && !!callCtx?.send;\r\n  const effectiveWsOpen = useSharedWs || useCtxForOutgoing ? (callCtx?.wsReady ?? false) : wsOpen;\r\n\r\n  useEffect(() => {\r\n    const wantVideo = !!isVideo;\r\n    let stream = null;\r\n    navigator.mediaDevices\r\n      .getUserMedia({ video: wantVideo, audio: true })\r\n      .then((s) => {\r\n        stream = s;\r\n        setLocalStream(s);\r\n        if (muted) s.getAudioTracks().forEach((t) => (t.enabled = false));\r\n      })\r\n      .catch((e) => setError('Нет доступа к камере или микрофону'));\r\n    return () => {\r\n      if (stream) stream.getTracks().forEach((t) => t.stop());\r\n    };\r\n  }, [isVideo]);\r\n\r\n  useEffect(() => {\r\n    if (!localRef.current || !localStream) return;\r\n    localRef.current.srcObject = localStream;\r\n  }, [localStream]);\r\n\r\n  useEffect(() => {\r\n    if (!remoteRef.current || !remoteStream) return;\r\n    remoteRef.current.srcObject = remoteStream;\r\n  }, [remoteStream]);\r\n\r\n  useEffect(() => {\r\n    if (remoteRef.current) remoteRef.current.volume = speaker ? 1 : 0.6;\r\n  }, [speaker, remoteStream]);\r\n\r\n  useEffect(() => {\r\n    if (muted && localStream) localStream.getAudioTracks().forEach((t) => (t.enabled = false));\r\n    if (!muted && localStream) localStream.getAudioTracks().forEach((t) => (t.enabled = true));\r\n  }, [muted, localStream]);\r\n\r\n  const wsUrl = getWsUrl();\r\n  const token = typeof localStorage !== 'undefined' ? localStorage.getItem('aist_token') : null;\r\n\r\n  useEffect(() => {\r\n    if (useSharedWs || useCtxForOutgoing) return;\r\n    if (!peerUserId || !wsUrl || !token) return;\r\n    setWsOpen(false);\r\n    const base = wsUrl.startsWith('ws') ? wsUrl : wsUrl.replace(/^https?/, (s) => (s === 'https' ? 'wss' : 'ws'));\r\n    const url = `${base}?token=${encodeURIComponent(token)}`;\r\n    let ws = null;\r\n    try {\r\n      ws = new WebSocket(url);\r\n      wsRef.current = ws;\r\n      ws.onopen = () => setWsOpen(true);\r\n      ws.onmessage = (ev) => {\r\n        try {\r\n          const msg = JSON.parse(ev.data);\r\n          if (msg.event === 'call:answer' && (msg.payload?.sdp || msg.payload)) {\r\n            setStatus('connected');\r\n            const desc = msg.payload?.type ? msg.payload : { type: 'answer', sdp: msg.payload?.sdp || msg.payload };\r\n            if (pcRef.current) pcRef.current.setRemoteDescription(new RTCSessionDescription(desc)).catch(() => {});\r\n          }\r\n          if (msg.event === 'call:ice' && msg.payload?.candidate) {\r\n            if (pcRef.current) pcRef.current.addIceCandidate(new RTCIceCandidate(msg.payload.candidate)).catch(() => {});\r\n          }\r\n          if (msg.event === 'call:hangup') onEnd();\r\n        } catch {}\r\n      };\r\n      ws.onerror = () => setError('Ошибка соединения');\r\n      ws.onclose = () => setWsOpen(false);\r\n    } catch (e) {\r\n      setError('WebSocket недоступен');\r\n    }\r\n    return () => {\r\n      if (pcRef.current) {\r\n        pcRef.current.close();\r\n        pcRef.current = null;\r\n      }\r\n      if (ws && ws.readyState === WebSocket.OPEN) ws.close();\r\n      wsRef.current = null;\r\n      setWsOpen(false);\r\n      offerSentRef.current = false;\r\n    };\r\n  }, [useSharedWs, useCtxForOutgoing, peerUserId, wsUrl, token, onEnd]);\r\n\r\n  useEffect(() => {\r\n    if (useSharedWs && callCtx && isIncoming && remoteOffer && localStream) {\r\n      callCtx.setMessageReceiver((msg) => {\r\n        if (msg.event === 'call:ice' && msg.payload?.candidate && pcRef.current) {\r\n          pcRef.current.addIceCandidate(new RTCIceCandidate(msg.payload.candidate)).catch(() => {});\r\n        }\r\n        if (msg.event === 'call:hangup') onEnd();\r\n      });\r\n      return () => callCtx.setMessageReceiver(null);\r\n    }\r\n  }, [useSharedWs, isIncoming, remoteOffer, localStream, callCtx, onEnd]);\r\n\r\n  useEffect(() => {\r\n    if (!localStream || !peerUserId) return;\r\n    if (isIncoming && remoteOffer && callCtx?.wsReady && callCtx.send) {\r\n      const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });\r\n      pcRef.current = pc;\r\n      localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));\r\n      pc.ontrack = (e) => setRemoteStream(e.streams[0] || e.stream);\r\n      pc.onicecandidate = (e) => {\r\n        if (e.candidate && callCtx?.send) callCtx.send('call:ice', { candidate: e.candidate });\r\n      };\r\n      pc.setRemoteDescription(new RTCSessionDescription(remoteOffer))\r\n        .then(() => pc.createAnswer())\r\n        .then((answer) => pc.setLocalDescription(answer).then(() => answer))\r\n        .then((answer) => {\r\n          callCtx.send('call:answer', { sdp: answer });\r\n          setStatus('connected');\r\n        })\r\n        .catch(() => setError('Ошибка соединения'));\r\n      return () => {\r\n        pc.close();\r\n        pcRef.current = null;\r\n      };\r\n    }\r\n    const sendOffer = (offer) => {\r\n      if (useCtxForOutgoing && callCtx?.send) {\r\n        callCtx.send('call:offer', { userId: peerUserId, targetUserId: peerUserId, sdp: offer, isVideo: !!isVideo });\r\n        offerSentRef.current = true;\r\n      } else if (wsRef.current?.readyState === WebSocket.OPEN) {\r\n        wsRef.current.send(JSON.stringify({ event: 'call:offer', payload: { userId: peerUserId, targetUserId: peerUserId, sdp: offer, isVideo: !!isVideo } }));\r\n        offerSentRef.current = true;\r\n      }\r\n    };\r\n    if (!isIncoming && effectiveWsOpen && !offerSentRef.current && (wsRef.current || useCtxForOutgoing)) {\r\n      if (useCtxForOutgoing) {\r\n        callCtx.setMessageReceiver((msg) => {\r\n          if (msg.event === 'call:answer' && (msg.payload?.sdp || msg.payload)) {\r\n            setStatus('connected');\r\n            const desc = msg.payload?.type ? msg.payload : { type: 'answer', sdp: msg.payload?.sdp || msg.payload };\r\n            if (pcRef.current) pcRef.current.setRemoteDescription(new RTCSessionDescription(desc)).catch(() => {});\r\n          }\r\n          if (msg.event === 'call:ice' && msg.payload?.candidate && pcRef.current) {\r\n            pcRef.current.addIceCandidate(new RTCIceCandidate(msg.payload.candidate)).catch(() => {});\r\n          }\r\n          if (msg.event === 'call:hangup') onEnd();\r\n        });\r\n      }\r\n      const pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] });\r\n      pcRef.current = pc;\r\n      localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));\r\n      pc.ontrack = (e) => setRemoteStream(e.streams[0] || e.stream);\r\n      pc.onicecandidate = (e) => {\r\n        if (e.candidate && useCtxForOutgoing && callCtx?.send) callCtx.send('call:ice', { candidate: e.candidate });\r\n        else if (e.candidate && wsRef.current?.readyState === WebSocket.OPEN) wsRef.current.send(JSON.stringify({ event: 'call:ice', payload: { candidate: e.candidate } }));\r\n      };\r\n      pc.createOffer()\r\n        .then((offer) => pc.setLocalDescription(offer).then(() => offer))\r\n        .then(sendOffer)\r\n        .catch(() => setError('Ошибка создания предложения'));\r\n      return () => {\r\n        if (useCtxForOutgoing) callCtx.setMessageReceiver(null);\r\n        if (pcRef.current === pc) {\r\n          pc.close();\r\n          pcRef.current = null;\r\n        }\r\n        offerSentRef.current = false;\r\n      };\r\n    }\r\n  }, [localStream, effectiveWsOpen, wsOpen, peerUserId, isIncoming, remoteOffer, callCtx, isVideo, useCtxForOutgoing, onEnd]);\r\n\r\n  const controlBtn = (Icon, active, onClick, label) => (\r\n    <button\r\n      type=\"button\"\r\n      onClick={onClick}\r\n      style={{\r\n        width: 56,\r\n        height: 56,\r\n        borderRadius: '50%',\r\n        border: 'none',\r\n        background: active ? theme.accent : (theme.sidebarBg || 'rgba(255,255,255,.12)'),\r\n        color: active ? theme.accentText : theme.text,\r\n        display: 'flex',\r\n        alignItems: 'center',\r\n        justifyContent: 'center',\r\n        cursor: 'pointer',\r\n      }}\r\n      title={label}\r\n      aria-label={label}\r\n    >\r\n      <Icon width={24} height={24} />\r\n    </button>\r\n  );\r\n\r\n  const styles = {\r\n    overlay: {\r\n      position: 'fixed',\r\n      inset: 0,\r\n      background: theme.isDark ? '#0c0c0e' : '#f5f5f7',\r\n      zIndex: 1000,\r\n      display: 'flex',\r\n      flexDirection: 'column',\r\n      color: theme.text,\r\n    },\r\n    header: {\r\n      padding: '12px 16px',\r\n      display: 'flex',\r\n      alignItems: 'center',\r\n      gap: 12,\r\n      borderBottom: `1px solid ${theme.border}`,\r\n      background: theme.headerBg,\r\n    },\r\n    center: {\r\n      flex: 1,\r\n      display: 'flex',\r\n      flexDirection: 'column',\r\n      alignItems: 'center',\r\n      justifyContent: 'center',\r\n      padding: 24,\r\n    },\r\n    avatar: {\r\n      width: 88,\r\n      height: 88,\r\n      borderRadius: '50%',\r\n      background: theme.accent,\r\n      color: theme.accentText,\r\n      display: 'flex',\r\n      alignItems: 'center',\r\n      justifyContent: 'center',\r\n      fontSize: 36,\r\n      fontWeight: 600,\r\n      marginBottom: 16,\r\n    },\r\n    name: { fontSize: 22, fontWeight: 600, marginBottom: 4 },\r\n    statusText: { fontSize: 15, color: theme.textMuted },\r\n    remoteVideo: {\r\n      position: 'absolute',\r\n      inset: 0,\r\n      width: '100%',\r\n      height: '100%',\r\n      objectFit: 'cover',\r\n    },\r\n    localVideo: {\r\n      position: 'absolute',\r\n      bottom: 100,\r\n      right: 16,\r\n      width: 100,\r\n      height: 140,\r\n      borderRadius: 12,\r\n      objectFit: 'cover',\r\n      border: `2px solid ${theme.border}`,\r\n    },\r\n    controls: {\r\n      padding: '24px 16px 32px',\r\n      paddingBottom: 'max(32px, env(safe-area-inset-bottom))',\r\n      display: 'flex',\r\n      justifyContent: 'center',\r\n      alignItems: 'center',\r\n      gap: 28,\r\n    },\r\n    endBtn: {\r\n      width: 64,\r\n      height: 64,\r\n      borderRadius: '50%',\r\n      border: 'none',\r\n      background: '#e53935',\r\n      color: '#fff',\r\n      display: 'flex',\r\n      alignItems: 'center',\r\n      justifyContent: 'center',\r\n      cursor: 'pointer',\r\n    },\r\n  };\r\n\r\n  return (\r\n    <div style={styles.overlay}>\r\n      <header style={styles.header}>\r\n        <button type=\"button\" style={{ border: 'none', background: 'transparent', color: theme.accent, padding: 8 }} onClick={onEnd} aria-label=\"Назад\">\r\n          <IconBack width={24} height={24} />\r\n        </button>\r\n        <span style={{ flex: 1, fontSize: 17, fontWeight: 600 }}>\r\n          {isVideo ? 'Видеозвонок' : 'Голосовой звонок'} — {peerName}\r\n        </span>\r\n      </header>\r\n\r\n      <div style={{ flex: 1, position: 'relative' }}>\r\n        {error && (\r\n          <div style={{ padding: 16, textAlign: 'center', color: '#e53935' }}>{error}</div>\r\n        )}\r\n        {!error && isVideo && localStream && (\r\n          <>\r\n            {remoteStream && <video ref={remoteRef} autoPlay playsInline style={styles.remoteVideo} />}\r\n            <video ref={localRef} autoPlay muted playsInline style={styles.localVideo} />\r\n          </>\r\n        )}\r\n        {!error && (!isVideo || !localStream) && (\r\n          <div style={styles.center}>\r\n            <div style={styles.avatar}>{peerName ? peerName[0].toUpperCase() : '?'}</div>\r\n            <div style={styles.name}>{peerName}</div>\r\n            <div style={styles.statusText}>{status === 'connected' ? 'Разговор' : isIncoming ? 'Подключение...' : 'Вызов...'}</div>\r\n          </div>\r\n        )}\r\n      </div>\r\n\r\n      <div style={styles.controls}>\r\n        {controlBtn(muted ? IconMicOff : IconMic, muted, () => setMuted(!muted), muted ? 'Включить микрофон' : 'Выключить микрофон')}\r\n        {controlBtn(IconSpeaker, speaker, () => setSpeaker(!speaker), speaker ? 'Телефон' : 'Громкая связь')}\r\n        {controlBtn(IconKeypad, showKeypad, () => setShowKeypad(!showKeypad), 'Клавиатура')}\r\n        <button type=\"button\" style={styles.endBtn} onClick={() => { if (useSharedWs && callCtx) callCtx.send('call:hangup'); onEnd(); }} title=\"Завершить\" aria-label=\"Завершить звонок\">\r\n          <span style={{ fontSize: 28, lineHeight: 1, color: '#fff' }}>✕</span>\r\n        </button>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}