{"ast":null,"code":"/**\r\n * Хранение чатов и сообщений на устройстве пользователя.\r\n * Чаты хранятся только локально (localStorage). Синхронизация с сервером — отдельный этап.\r\n */\n\nconst PREFIX = 'aist_chat_';\nconst LIST_KEY = 'aist_chat_list';\nfunction getChatKey(chatId) {\n  return PREFIX + chatId;\n}\nexport function getChatList() {\n  try {\n    const raw = localStorage.getItem(LIST_KEY);\n    return raw ? JSON.parse(raw) : [];\n  } catch {\n    return [];\n  }\n}\nexport function saveChatList(list) {\n  try {\n    localStorage.setItem(LIST_KEY, JSON.stringify(list));\n  } catch {}\n}\nexport function getMessages(chatId) {\n  try {\n    const raw = localStorage.getItem(getChatKey(chatId));\n    return raw ? JSON.parse(raw) : [];\n  } catch {\n    return [];\n  }\n}\nexport function appendMessage(chatId, message) {\n  const messages = getMessages(chatId);\n  const next = [...messages, {\n    ...message,\n    id: message.id || `m_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`\n  }];\n  try {\n    localStorage.setItem(getChatKey(chatId), JSON.stringify(next));\n    return next;\n  } catch {\n    return messages;\n  }\n}\n\n/** Записать сообщения чата (при синхронизации с сервера). Храним только на устройстве. */\nexport function saveMessages(chatId, list) {\n  const arr = Array.isArray(list) ? list : [];\n  try {\n    localStorage.setItem(getChatKey(chatId), JSON.stringify(arr));\n    return arr;\n  } catch {\n    return getMessages(chatId);\n  }\n}\nexport function addOrUpdateChat(chat) {\n  const list = getChatList();\n  const idx = list.findIndex(c => c.id === chat.id);\n  const next = [...list];\n  if (idx >= 0) {\n    next[idx] = {\n      ...next[idx],\n      ...chat,\n      updatedAt: Date.now()\n    };\n  } else {\n    next.unshift({\n      ...chat,\n      updatedAt: Date.now()\n    });\n  }\n  saveChatList(next);\n  return next;\n}\nconst CHANNEL_META_PREFIX = 'aist_channel_meta_';\nexport function getChannelMeta(chatId) {\n  try {\n    const raw = localStorage.getItem(CHANNEL_META_PREFIX + chatId);\n    return raw ? JSON.parse(raw) : {\n      description: '',\n      shareLink: '',\n      admins: [],\n      moderators: []\n    };\n  } catch {\n    return {\n      description: '',\n      shareLink: '',\n      admins: [],\n      moderators: []\n    };\n  }\n}\nexport function saveChannelMeta(chatId, meta) {\n  try {\n    localStorage.setItem(CHANNEL_META_PREFIX + chatId, JSON.stringify(meta));\n  } catch {}\n}\nexport function createChat({\n  id,\n  name,\n  type = 'user',\n  avatar,\n  description,\n  shareLink,\n  admins,\n  moderators\n}) {\n  const chatId = id || `chat_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;\n  const link = shareLink || (type === 'channel' ? `https://aist-messenger.vercel.app/c/${chatId}` : '');\n  addOrUpdateChat({\n    id: chatId,\n    name: name || 'Чат',\n    type,\n    avatar: avatar || (type === 'channel' ? 'channel' : 'group'),\n    lastMessage: '',\n    lastTime: null,\n    unread: 0\n  });\n  if (type === 'channel') {\n    saveChannelMeta(chatId, {\n      description: description || '',\n      shareLink: link,\n      admins: admins || [],\n      moderators: moderators || []\n    });\n  }\n  return chatId;\n}","map":{"version":3,"names":["PREFIX","LIST_KEY","getChatKey","chatId","getChatList","raw","localStorage","getItem","JSON","parse","saveChatList","list","setItem","stringify","getMessages","appendMessage","message","messages","next","id","Date","now","Math","random","toString","slice","saveMessages","arr","Array","isArray","addOrUpdateChat","chat","idx","findIndex","c","updatedAt","unshift","CHANNEL_META_PREFIX","getChannelMeta","description","shareLink","admins","moderators","saveChannelMeta","meta","createChat","name","type","avatar","link","lastMessage","lastTime","unread"],"sources":["C:/Users/Vladislav/Documents/GitHub/aist-messenger/src/lib/chatStorage.js"],"sourcesContent":["/**\r\n * Хранение чатов и сообщений на устройстве пользователя.\r\n * Чаты хранятся только локально (localStorage). Синхронизация с сервером — отдельный этап.\r\n */\r\n\r\nconst PREFIX = 'aist_chat_';\r\nconst LIST_KEY = 'aist_chat_list';\r\n\r\nfunction getChatKey(chatId) {\r\n  return PREFIX + chatId;\r\n}\r\n\r\nexport function getChatList() {\r\n  try {\r\n    const raw = localStorage.getItem(LIST_KEY);\r\n    return raw ? JSON.parse(raw) : [];\r\n  } catch {\r\n    return [];\r\n  }\r\n}\r\n\r\nexport function saveChatList(list) {\r\n  try {\r\n    localStorage.setItem(LIST_KEY, JSON.stringify(list));\r\n  } catch {}\r\n}\r\n\r\nexport function getMessages(chatId) {\r\n  try {\r\n    const raw = localStorage.getItem(getChatKey(chatId));\r\n    return raw ? JSON.parse(raw) : [];\r\n  } catch {\r\n    return [];\r\n  }\r\n}\r\n\r\nexport function appendMessage(chatId, message) {\r\n  const messages = getMessages(chatId);\r\n  const next = [...messages, { ...message, id: message.id || `m_${Date.now()}_${Math.random().toString(36).slice(2, 9)}` }];\r\n  try {\r\n    localStorage.setItem(getChatKey(chatId), JSON.stringify(next));\r\n    return next;\r\n  } catch {\r\n    return messages;\r\n  }\r\n}\r\n\r\n/** Записать сообщения чата (при синхронизации с сервера). Храним только на устройстве. */\r\nexport function saveMessages(chatId, list) {\r\n  const arr = Array.isArray(list) ? list : [];\r\n  try {\r\n    localStorage.setItem(getChatKey(chatId), JSON.stringify(arr));\r\n    return arr;\r\n  } catch {\r\n    return getMessages(chatId);\r\n  }\r\n}\r\n\r\nexport function addOrUpdateChat(chat) {\r\n  const list = getChatList();\r\n  const idx = list.findIndex((c) => c.id === chat.id);\r\n  const next = [...list];\r\n  if (idx >= 0) {\r\n    next[idx] = { ...next[idx], ...chat, updatedAt: Date.now() };\r\n  } else {\r\n    next.unshift({ ...chat, updatedAt: Date.now() });\r\n  }\r\n  saveChatList(next);\r\n  return next;\r\n}\r\n\r\nconst CHANNEL_META_PREFIX = 'aist_channel_meta_';\r\n\r\nexport function getChannelMeta(chatId) {\r\n  try {\r\n    const raw = localStorage.getItem(CHANNEL_META_PREFIX + chatId);\r\n    return raw ? JSON.parse(raw) : { description: '', shareLink: '', admins: [], moderators: [] };\r\n  } catch {\r\n    return { description: '', shareLink: '', admins: [], moderators: [] };\r\n  }\r\n}\r\n\r\nexport function saveChannelMeta(chatId, meta) {\r\n  try {\r\n    localStorage.setItem(CHANNEL_META_PREFIX + chatId, JSON.stringify(meta));\r\n  } catch {}\r\n}\r\n\r\nexport function createChat({ id, name, type = 'user', avatar, description, shareLink, admins, moderators }) {\r\n  const chatId = id || `chat_${Date.now()}_${Math.random().toString(36).slice(2, 9)}`;\r\n  const link = shareLink || (type === 'channel' ? `https://aist-messenger.vercel.app/c/${chatId}` : '');\r\n  addOrUpdateChat({\r\n    id: chatId,\r\n    name: name || 'Чат',\r\n    type,\r\n    avatar: avatar || (type === 'channel' ? 'channel' : 'group'),\r\n    lastMessage: '',\r\n    lastTime: null,\r\n    unread: 0,\r\n  });\r\n  if (type === 'channel') {\r\n    saveChannelMeta(chatId, {\r\n      description: description || '',\r\n      shareLink: link,\r\n      admins: admins || [],\r\n      moderators: moderators || [],\r\n    });\r\n  }\r\n  return chatId;\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}